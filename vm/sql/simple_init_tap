#!/bin/sh
# TEAM_016: Simple init script with TAP networking (gvforwarder removed)
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

exec > /init.log 2>&1
echo "=== SIMPLE INIT START (TAP) ==="
date

mount -t proc proc /proc
mount -t sysfs sysfs /sys

# Create device nodes
mkdir -p /dev/net
[ -e /dev/net/tun ] || mknod /dev/net/tun c 10 200
chmod 666 /dev/net/tun

# TEAM_016: Configure TAP networking (eth0 via virtio-net)
# Host TAP is 192.168.100.1, guest is 192.168.100.2
echo "=== Configuring TAP Network ==="

# Wait for eth0 to appear
for i in 1 2 3 4 5; do
    if ip link show eth0 >/dev/null 2>&1; then
        break
    fi
    echo "Waiting for eth0..."
    sleep 1
done

if ip link show eth0 >/dev/null 2>&1; then
    echo "Found eth0, configuring network..."
    ip addr add 192.168.100.2/24 dev eth0
    ip link set eth0 up
    ip route add default via 192.168.100.1
    echo "nameserver 8.8.8.8" > /etc/resolv.conf
    echo "Network configured on eth0"
    ip addr show eth0
else
    echo "WARNING: eth0 not found"
    ip link
fi

# Start Tailscale
AUTHKEY=$(cat /proc/cmdline | tr ' ' '\n' | grep tailscale.authkey | cut -d= -f2)
if [ -n "$AUTHKEY" ]; then
    echo "=== Starting Tailscale ==="
    mkdir -p /var/lib/tailscale
    /usr/sbin/tailscaled --tun=userspace-networking --state=/var/lib/tailscale/tailscaled.state &
    sleep 5
    /usr/bin/tailscale up --authkey="$AUTHKEY" --hostname=sql-vm
fi

# Start PostgreSQL
echo "=== Starting PostgreSQL ==="
mkdir -p /run/postgresql /data/postgres
chown -R postgres:postgres /run/postgresql /data/postgres
if [ ! -f /data/postgres/PG_VERSION ]; then
    echo "Initializing PostgreSQL database..."
    su postgres -c "initdb -D /data/postgres"
    su postgres -c "pg_ctl -D /data/postgres -l /tmp/pg.log start"
    sleep 2
    su postgres -c "pg_ctl -D /data/postgres stop"
fi
su postgres -c "pg_ctl -D /data/postgres -l /var/log/postgresql.log start"
echo "PostgreSQL started"

echo "=== INIT COMPLETE ==="
while true; do sleep 3600; done
